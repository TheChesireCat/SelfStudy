<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SelfStudy Library</title>
    
    <!-- PDF.js Viewer CSS -->
    <link href="https://cdn.jsdelivr.net/npm/pdf.js-viewer@0.2.8/viewer.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar Styles */
        #sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            transition: transform 0.25s ease;
        }

        #header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        #header h1 {
            font-size: 22px;
            margin-bottom: 5px;
        }

        #header p {
            font-size: 13px;
            opacity: 0.9;
        }

        #file-tree {
            padding: 15px;
            flex: 1;
        }

        .category {
            margin-bottom: 10px;
        }

        .category-header {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            font-weight: 600;
            color: #333;
            background: #f8f9fa;
            font-size: 13px;
            transition: background 0.2s;
        }

        .category-header:hover {
            background: #e9ecef;
        }

        .category-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .category-content {
            margin-left: 15px;
            margin-top: 5px;
            display: none;
            padding-left: 10px;
            border-left: 2px solid #e9ecef;
        }

        .category-content.open {
            display: block;
        }

        .subcategory {
            margin-bottom: 8px;
        }

        .subcategory-header {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: 500;
            font-size: 12px;
            color: #555;
            transition: background 0.2s;
        }

        .subcategory-header:hover {
            background: #f8f9fa;
        }

        .file-list {
            margin-left: 10px;
            margin-top: 3px;
            display: none;
        }

        .file-list.open {
            display: block;
        }

        .file {
            padding: 6px 10px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #666;
            transition: all 0.2s;
            margin: 2px 0;
        }

        .file:hover {
            background: #f0f0f0;
            color: #667eea;
        }

        .file.selected {
            background: #667eea;
            color: white;
            font-weight: 500;
        }

        .file-icon {
            margin-right: 6px;
            font-size: 12px;
        }

        
        #bookmark-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 18px;
            border-bottom: 1px solid #e0e0e0;
            background: #fff;
        }

        #bookmark-controls .bookmark-header {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .bookmark-button {
            padding: 6px 10px;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            background: #f8f9fa;
            color: #333;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
            text-align: left;
        }

        .bookmark-button:hover:not(:disabled) {
            background: #667eea;
            color: #fff;
            border-color: #667eea;
        }

        .bookmark-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #bookmark-status {
            font-size: 13px;
            color: #667eea;
            min-height: 1em;
            transition: opacity 0.2s ease;
            opacity: 0;
        }

        #bookmark-status.visible {
            opacity: 1;
        }

        #bookmark-status:not(.visible) {
            pointer-events: none;
        }

        /* PDF Viewer Container */
        #viewer-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #f5f6f8;
            min-height: 0;
        }

        #pdfjs-viewer {
            width: 100%;
            height: 100%;
        }

        #placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #f5f5f5;
            color: #999;
        }

        #placeholder-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        #placeholder-text {
            font-size: 18px;
        }

        #sidebar-toggle {
            display: none;
        }

        #sidebar-backdrop {
            display: none;
        }

        @media (max-width: 960px) {
            #sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                max-width: 80vw;
                width: 280px;
                transform: translateX(-100%);
                border-right: none;
                border-bottom: none;
                box-shadow: 2px 0 16px rgba(0, 0, 0, 0.25);
                z-index: 1000;
            }

            #sidebar.open {
                transform: translateX(0);
            }

            #sidebar-toggle {
                position: fixed;
                top: 16px;
                right: 16px;
                display: flex;
                align-items: center;
                gap: 6px;
                padding: 10px 14px;
                border: none;
                border-radius: 999px;
                background: rgba(255, 255, 255, 0.85);
                color: #333;
                font-weight: 600;
                font-size: 14px;
                box-shadow: 0 4px 18px rgba(0, 0, 0, 0.12);
                z-index: 1100;
            }

            #sidebar-toggle:focus-visible {
                outline: 2px solid rgba(102, 126, 234, 0.7);
                outline-offset: 2px;
            }

            #sidebar-toggle.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: #fff;
            }

            #sidebar-backdrop {
                position: fixed;
                inset: 0;
                background: rgba(17, 24, 39, 0.35);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.25s ease;
                display: block;
                z-index: 900;
            }

            #sidebar-backdrop.visible {
                opacity: 1;
                pointer-events: all;
            }

            #viewer-container {
                height: 100vh;
                width: 100%;
            }

            #pdfjs-viewer {
                height: calc(100vh);
            }
        }

    </style>
</head>
<body>
    <button id="sidebar-toggle" type="button" aria-label="Toggle library navigation" aria-controls="sidebar" aria-expanded="false">
        ‚ò∞ Library
    </button>
    <!-- Sidebar with file tree -->
    <div id="sidebar">
        <div id="header">
            <h1>üìö SelfStudy Library</h1>
            <p>Network Science & Complex Systems</p>
        </div>
        <div id="bookmark-controls" role="region" aria-label="Bookmark controls">
            <div class="bookmark-header">Reading Progress</div>
            <button type="button" class="bookmark-button bookmark-save">Bookmark Page</button>
            <button type="button" class="bookmark-button bookmark-resume">Resume Bookmark</button>
            <button type="button" class="bookmark-button bookmark-clear">Clear Bookmark</button>
            <div id="bookmark-status" aria-live="polite"></div>
        </div>
        <div id="file-tree">
            <!-- 01-Foundations -->
            <div class="category">
                <div class="category-header" onclick="toggleCategory(this)">
                    <span class="category-icon">üìÅ</span>
                    <span>01-Foundations</span>
                </div>
                <div class="category-content">
                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Mathematics
                        </div>
                        <div class="file-list">
                            <div class="subcategory-header" onclick="toggleSubcategory(this)" style="margin-left: 10px;">
                                Calculus
                            </div>
                            <div class="file-list" style="margin-left: 20px;">
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Calculus/Crash-Course-in-Vector-Calculus.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Crash Course in Vector Calculus</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Calculus/Single-and-Multivariable-Calculus-Early-Transcendentals.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Single & Multivariable Calculus</span>
                                </div>
                            </div>

                            <div class="subcategory-header" onclick="toggleSubcategory(this)" style="margin-left: 10px;">
                                Linear Algebra
                            </div>
                            <div class="file-list" style="margin-left: 20px;">
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Linear-Algebra/Linear-Algebra-and-Multivariable-Calculus-Chen-MIT-18.02.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Linear Algebra - MIT 18.02 (Chen)</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Linear-Algebra/Linear-Algebra-Cherney-Denton-Thomas-Waldron.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Linear Algebra (Cherney et al.)</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Linear-Algebra/Topics-in-Random-Matrix-Theory-Tao.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Random Matrix Theory (Tao)</span>
                                </div>
                            </div>

                            <div class="subcategory-header" onclick="toggleSubcategory(this)" style="margin-left: 10px;">
                                Probability & Statistics
                            </div>
                            <div class="file-list" style="margin-left: 20px;">
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Probability-Statistics/All-of-Statistics-Wasserman-2004.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>All of Statistics (Wasserman)</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Probability-Statistics/Introduction-to-Econometrics-Stock-Watson-2020.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Econometrics (Stock & Watson)</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Probability-Statistics/Introduction-to-Mathematical-Statistics-8th-Ed-Hogg.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Mathematical Statistics (Hogg)</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Probability-Statistics/Introduction-to-Probability-Models-Ross.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Probability Models (Ross)</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Probability-Statistics/Introduction-to-Probability-and-Statistics-Mendenhall-Beaver.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Probability & Statistics (Mendenhall)</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Probability-Statistics/Probability-Cheatsheet-CME106-Amidi.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Probability Cheatsheet (CME106)</span>
                                </div>
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Probability-Statistics/Statistics-Cheatsheet-CME106-Amidi.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Statistics Cheatsheet (CME106)</span>
                                </div>
                            </div>

                            <div class="subcategory-header" onclick="toggleSubcategory(this)" style="margin-left: 10px;">
                                Numerical Methods
                            </div>
                            <div class="file-list" style="margin-left: 20px;">
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Mathematics/Numerical-Methods/Numerical-Recipes-Press-et-al-2007.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Numerical Recipes (Press et al.)</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Computer Science
                        </div>
                        <div class="file-list">
                            <div class="subcategory-header" onclick="toggleSubcategory(this)" style="margin-left: 10px;">
                                Algorithms
                            </div>
                            <div class="file-list" style="margin-left: 20px;">
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Computer-Science/Algorithms/Introduction-to-Algorithms-4th-Ed-CLRS.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>Introduction to Algorithms (CLRS)</span>
                                </div>
                            </div>

                            <div class="subcategory-header" onclick="toggleSubcategory(this)" style="margin-left: 10px;">
                                System Design
                            </div>
                            <div class="file-list" style="margin-left: 20px;">
                                <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/01-Foundations/Computer-Science/System-Design/System-Design-Interview-Xu.pdf', this)">
                                    <span class="file-icon">üìÑ</span>
                                    <span>System Design Interview (Xu)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 02-Network-Science -->
            <div class="category">
                <div class="category-header" onclick="toggleCategory(this)">
                    <span class="category-icon">üìÅ</span>
                    <span>02-Network-Science</span>
                </div>
                <div class="category-content">
                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Graph Theory
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/02-Network-Science/Graph-Theory/Graph-Theory-Deo.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Graph Theory (Deo)</span>
                            </div>
                        </div>
                    </div>

                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Complex Networks
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/02-Network-Science/Complex-Networks/Modeling-and-Analysis-of-Complex-Systems-Sayama.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Complex Systems (Sayama)</span>
                            </div>
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/02-Network-Science/Complex-Networks/Networks-Newman-2018.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Networks (Newman 2018)</span>
                            </div>
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/02-Network-Science/Complex-Networks/Networks-Newman-Alt-Edition.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Networks (Newman Alt)</span>
                            </div>
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/02-Network-Science/Complex-Networks/Networks-Crowds-and-Markets-Easley-Kleinberg.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Networks, Crowds, Markets</span>
                            </div>
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/02-Network-Science/Complex-Networks/Network-Science-Barabasi.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Network Science (Barab√°si)</span>
                            </div>
                        </div>
                    </div>

                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Machine Learning on Graphs
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/02-Network-Science/Machine-Learning-on-Graphs/CS224W-Machine-Learning-with-Graphs-Stanford.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>CS224W (Stanford)</span>
                            </div>
                        </div>
                    </div>

                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Network Dynamics
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/02-Network-Science/Network-Dynamics/Dynamical-Processes-on-Complex-Networks-Barrat-et-al-2008.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Dynamical Processes (Barrat)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 03-Complex-Systems -->
            <div class="category">
                <div class="category-header" onclick="toggleCategory(this)">
                    <span class="category-icon">üìÅ</span>
                    <span>03-Complex-Systems</span>
                </div>
                <div class="category-content">
                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Nonlinear Dynamics & Chaos
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/03-Complex-Systems/Nonlinear-Dynamics-Chaos/Nonlinear-Dynamics-and-Chaos-Strogatz-2024.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Nonlinear Dynamics (Strogatz)</span>
                            </div>
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/03-Complex-Systems/Nonlinear-Dynamics-Chaos/Nonlinear-Dynamics-and-Chaos-Solutions-Manual-Strogatz-2024.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Solutions Manual (Strogatz)</span>
                            </div>
                        </div>
                    </div>

                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Urban Science
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/03-Complex-Systems/Urban-Science/Introduction-to-Urban-Science-Bettencourt-2021.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Urban Science (Bettencourt)</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 04-Applied-Methods -->
            <div class="category">
                <div class="category-header" onclick="toggleCategory(this)">
                    <span class="category-icon">üìÅ</span>
                    <span>04-Applied-Methods</span>
                </div>
                <div class="category-content">
                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Epidemiology
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/04-Applied-Methods/Epidemiology/Mathematics-of-Epidemics-on-Networks-Kiss-Miller-Simon.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Epidemics on Networks</span>
                            </div>
                        </div>
                    </div>

                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Research Design
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/04-Applied-Methods/Research-Design/Research-Design-and-Methods-Bordens-Abbott-2022.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Research Design & Methods</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 05-General-Reading -->
            <div class="category">
                <div class="category-header" onclick="toggleCategory(this)">
                    <span class="category-icon">üìÅ</span>
                    <span>05-General-Reading</span>
                </div>
                <div class="category-content">
                    <div class="subcategory">
                        <div class="subcategory-header" onclick="toggleSubcategory(this)">
                            Popular Science
                        </div>
                        <div class="file-list">
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/05-General-Reading/Complexity-A-Guided-Tour-Mitchell.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Complexity: A Guided Tour</span>
                            </div>
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/05-General-Reading/Scale-West.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>Scale (West)</span>
                            </div>
                            <div class="file" onclick="loadPDF('https://media.githubusercontent.com/media/TheChesireCat/SelfStudy/main/05-General-Reading/The-Nature-of-Computation-Moore-Mertens.pdf', this)">
                                <span class="file-icon">üìÑ</span>
                                <span>The Nature of Computation</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="sidebar-backdrop" aria-hidden="true"></div>

    <!-- PDF Viewer Container -->
    <div id="viewer-container">
        <div id="placeholder">
            <div id="placeholder-icon">üìÑ</div>
            <div id="placeholder-text">Select a PDF from the sidebar to start reading</div>
        </div>
        <iframe id="pdfjs-viewer" style="display: none;" frameborder="0"></iframe>
    </div>

    <script>
        function toggleCategory(header) {
            const content = header.nextElementSibling;
            content.classList.toggle('open');
            const icon = header.querySelector('.category-icon');
            icon.textContent = content.classList.contains('open') ? 'üìÇ' : 'üìÅ';
        }

        function toggleSubcategory(header) {
            const content = header.nextElementSibling;
            if (content && content.classList.contains('file-list')) {
                content.classList.toggle('open');
            }
        }

        
        const placeholder = document.getElementById('placeholder');
        const viewer = document.getElementById('pdfjs-viewer');
        const sidebar = document.getElementById('sidebar');
        const sidebarBackdrop = document.getElementById('sidebar-backdrop');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const mobileQuery = window.matchMedia('(max-width: 960px)');
        const isFileProtocol = window.location.protocol === 'file:';
        const messageTargetOrigin = isFileProtocol ? '*' : window.location.origin;

        const bookmarkControls = document.getElementById('bookmark-controls');
        const bookmarkSaveButton = bookmarkControls ? bookmarkControls.querySelector('.bookmark-save') : null;
        const bookmarkResumeButton = bookmarkControls ? bookmarkControls.querySelector('.bookmark-resume') : null;
        const bookmarkClearButton = bookmarkControls ? bookmarkControls.querySelector('.bookmark-clear') : null;
        const bookmarkStatus = document.getElementById('bookmark-status');
        const STORAGE_KEY = 'pdfBookmarks';
        const LAST_DOCUMENT_KEY = 'pdfLastDocument';
        const AUTO_SAVE_DEBOUNCE_MS = 2000;
        const AUTO_SAVE_IDLE_TIMEOUT_MS = 5000;

        let viewerReady = false;
        let pendingFile = null;
        let currentDocumentUrl = null;
        let currentViewerSource = null;
        let bookmarkStatusTimer = null;
        let currentDocumentKey = null;

        let bookmarks = loadBookmarks();
        let lastDocument = loadLastDocument();
        let pendingAutoSave = null;
        let autoSaveTimeoutId = null;
        let autoSaveIdleCallbackId = null;
        let lastAutoSaved = { url: null, pageNumber: null };

        initializeFileMetadata();
        updateBookmarkUI();

        function loadBookmarks() {
            try {
                const raw = window.localStorage ? localStorage.getItem(STORAGE_KEY) : null;
                if (!raw) {
                    return {};
                }
                const parsed = JSON.parse(raw);
                return sanitizeBookmarkStore(parsed);
            } catch (error) {
                console.warn('Unable to access bookmark storage:', error);
                return {};
            }
        }

        function sanitizeBookmarkStore(store) {
            const result = {};
            if (!store || typeof store !== 'object') {
                return result;
            }
            for (const [url, value] of Object.entries(store)) {
                const entry = normalizeBookmarkEntry(value);
                if (!entry) {
                    continue;
                }
                const key = normalizePDFPath(url);
                if (key) {
                    result[key] = entry;
                }
            }
            return result;
        }

        function normalizeBookmarkEntry(value) {
            if (typeof value === 'number') {
                const page = Math.floor(value);
                if (Number.isInteger(page) && page > 0) {
                    return { pageNumber: page, updatedAt: Date.now() };
                }
                return null;
            }
            if (value && typeof value === 'object') {
                const page = Math.floor(Number(value.pageNumber));
                if (Number.isInteger(page) && page > 0) {
                    const timestamp = Number.isFinite(Number(value.updatedAt)) ? Number(value.updatedAt) : Date.now();
                    return { pageNumber: page, updatedAt: timestamp };
                }
            }
            return null;
        }

        function persistBookmarks() {
            try {
                if (window.localStorage) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(bookmarks));
                }
            } catch (error) {
                console.warn('Unable to persist bookmark:', error);
            }
        }

        function loadLastDocument() {
            try {
                const raw = window.localStorage ? localStorage.getItem(LAST_DOCUMENT_KEY) : null;
                if (!raw) {
                    return null;
                }
                const parsed = JSON.parse(raw);
                if (!parsed || typeof parsed !== 'object') {
                    return null;
                }
                const url = parsed.url ? normalizePDFPath(parsed.url) : null;
                if (!url) {
                    return null;
                }
                const page = Math.floor(Number(parsed.pageNumber));
                const updatedAt = Number.isFinite(Number(parsed.updatedAt)) ? Number(parsed.updatedAt) : Date.now();
                return {
                    url,
                    pageNumber: Number.isInteger(page) && page > 0 ? page : null,
                    updatedAt
                };
            } catch (error) {
                console.warn('Unable to load last document state:', error);
                return null;
            }
        }

        function persistLastDocument() {
            try {
                if (window.localStorage) {
                    localStorage.setItem(LAST_DOCUMENT_KEY, JSON.stringify(lastDocument));
                }
            } catch (error) {
                console.warn('Unable to persist last document state:', error);
            }
        }

        function rememberLastDocument(url, pageNumber) {
            if (!url) {
                return;
            }
            const normalizedUrl = normalizePDFPath(url);
            if (!normalizedUrl) {
                return;
            }
            const sanitizedPage = Number.isInteger(pageNumber) && pageNumber > 0 ? Math.floor(pageNumber) : null;
            lastDocument = {
                url: normalizedUrl,
                pageNumber: sanitizedPage,
                updatedAt: Date.now()
            };
            persistLastDocument();
        }

        function resolveBookmarkKey(url) {
            return url ? normalizePDFPath(url) : null;
        }

        function getBookmark(url) {
            const key = resolveBookmarkKey(url);
            return key && Object.prototype.hasOwnProperty.call(bookmarks, key) ? bookmarks[key] : undefined;
        }

        function getBookmarkPage(entry) {
            if (!entry || typeof entry !== 'object') {
                return null;
            }
            const page = Math.floor(Number(entry.pageNumber));
            return Number.isInteger(page) && page > 0 ? page : null;
        }

        function cancelPendingAutoSave() {
            if (autoSaveTimeoutId) {
                clearTimeout(autoSaveTimeoutId);
                autoSaveTimeoutId = null;
            }
            if (autoSaveIdleCallbackId && typeof window.cancelIdleCallback === 'function') {
                cancelIdleCallback(autoSaveIdleCallbackId);
                autoSaveIdleCallbackId = null;
            }
            pendingAutoSave = null;
        }

        function commitAutoSave() {
            if (!pendingAutoSave) {
                return;
            }
            const { url, pageNumber } = pendingAutoSave;
            pendingAutoSave = null;
            if (!url || !Number.isInteger(pageNumber) || pageNumber <= 0) {
                return;
            }
            const previous = getBookmark(url);
            const previousPage = getBookmarkPage(previous);
            if (previousPage === pageNumber) {
                lastAutoSaved = { url, pageNumber };
                return;
            }
            if (saveBookmark(url, pageNumber, { silent: true })) {
                lastAutoSaved = { url, pageNumber };
            }
        }

        function flushPendingAutoSave() {
            commitAutoSave();
            cancelPendingAutoSave();
        }

        function scheduleAutoSave(url, pageNumber) {
            if (!Number.isInteger(pageNumber) || pageNumber <= 0) {
                return;
            }
            const key = url ? resolveBookmarkKey(url) : currentDocumentKey;
            if (!key || key !== currentDocumentKey) {
                return;
            }
            const normalizedPage = Math.floor(pageNumber);
            if (lastAutoSaved.url === key && lastAutoSaved.pageNumber === normalizedPage) {
                return;
            }

            pendingAutoSave = { url: key, pageNumber: normalizedPage };

            if (autoSaveTimeoutId) {
                clearTimeout(autoSaveTimeoutId);
                autoSaveTimeoutId = null;
            }
            if (autoSaveIdleCallbackId && typeof window.cancelIdleCallback === 'function') {
                cancelIdleCallback(autoSaveIdleCallbackId);
                autoSaveIdleCallbackId = null;
            }

            if (typeof window.requestIdleCallback === 'function') {
                autoSaveIdleCallbackId = requestIdleCallback(() => {
                    autoSaveIdleCallbackId = null;
                    commitAutoSave();
                }, { timeout: AUTO_SAVE_IDLE_TIMEOUT_MS });
            } else {
                autoSaveTimeoutId = setTimeout(() => {
                    autoSaveTimeoutId = null;
                    commitAutoSave();
                }, AUTO_SAVE_DEBOUNCE_MS);
            }
        }

        function setSidebarOpen(open) {
            if (!sidebar) {
                return;
            }
            if (open) {
                sidebar.classList.add('open');
                if (sidebarBackdrop) {
                    sidebarBackdrop.classList.add('visible');
                }
                if (sidebarToggle) {
                    sidebarToggle.classList.add('active');
                    sidebarToggle.setAttribute('aria-expanded', 'true');
                }
            } else {
                sidebar.classList.remove('open');
                if (sidebarBackdrop) {
                    sidebarBackdrop.classList.remove('visible');
                }
                if (sidebarToggle) {
                    sidebarToggle.classList.remove('active');
                    sidebarToggle.setAttribute('aria-expanded', 'false');
                }
            }
        }

        function handleViewportChange(event) {
            if (event.matches) {
                setSidebarOpen(false);
            } else {
                setSidebarOpen(false);
                if (sidebarBackdrop) {
                    sidebarBackdrop.classList.remove('visible');
                }
            }
        }

        if (sidebarToggle) {
            sidebarToggle.addEventListener('click', () => {
                if (!mobileQuery.matches) {
                    return;
                }
                const isOpen = sidebar.classList.contains('open');
                setSidebarOpen(!isOpen);
            });
        }

        if (sidebarBackdrop) {
            sidebarBackdrop.addEventListener('click', () => setSidebarOpen(false));
        }

        if (mobileQuery.addEventListener) {
            mobileQuery.addEventListener('change', handleViewportChange);
        } else if (mobileQuery.addListener) {
            mobileQuery.addListener(handleViewportChange);
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && mobileQuery.matches) {
                setSidebarOpen(false);
            }
        });

        function normalizePDFPath(path) {
            if (!path) {
                return null;
            }
            if (!/^https?:\/\//i.test(path)) {
                return path;
            }
            try {
                const url = new URL(path);
                if (url.hostname !== 'github.com') {
                    return path;
                }
                const segments = url.pathname.split('/').filter(Boolean);
                const rawIndex = segments.indexOf('raw');
                if (rawIndex === -1) {
                    return path;
                }
                const owner = segments[0];
                const repo = segments[1];
                if (!owner || !repo) {
                    return path;
                }
                let branch;
                let fileSegments;
                const nextSegment = segments[rawIndex + 1];
                if (nextSegment === 'refs' && segments[rawIndex + 2] === 'heads') {
                    branch = segments[rawIndex + 3];
                    fileSegments = segments.slice(rawIndex + 4);
                } else {
                    branch = nextSegment;
                    fileSegments = segments.slice(rawIndex + 2);
                }
                if (!branch || !fileSegments.length) {
                    return path;
                }
                return `https://media.githubusercontent.com/media/${owner}/${repo}/${branch}/${fileSegments.join('/')}`;
            } catch (error) {
                return path;
            }
        }

        function ensureViewerLoaded() {
            if (!viewer.src) {
                viewer.src = 'viewer/viewer.html';
            }
        }

        function postOpenRequest(request) {
            if (!viewer.contentWindow) {
                return;
            }
            const payload = typeof request === 'string' ? { url: request } : request;
            viewer.contentWindow.postMessage(
                { type: 'openFile', payload },
                messageTargetOrigin
            );
        }

        function sendOpenRequest(options = {}) {
            if (!currentViewerSource) {
                return;
            }
            ensureViewerLoaded();
            const request = { url: currentViewerSource };
            if (options && options.pageNumber != null) {
                const pageNumber = Number(options.pageNumber);
                if (Number.isFinite(pageNumber) && pageNumber > 0) {
                    request.pageNumber = Math.floor(pageNumber);
                }
            }
            if (viewerReady && viewer.contentWindow) {
                postOpenRequest(request);
            } else {
                pendingFile = { ...request };
            }
        }

        function updateBookmarkUI() {
            const hasDocument = Boolean(currentDocumentUrl);
            const bookmarkEntry = hasDocument ? getBookmark(currentDocumentUrl) : null;
            const hasBookmark = getBookmarkPage(bookmarkEntry) !== null;
            if (bookmarkSaveButton) {
                bookmarkSaveButton.disabled = !hasDocument;
            }
            if (bookmarkResumeButton) {
                bookmarkResumeButton.disabled = !hasBookmark;
            }
            if (bookmarkClearButton) {
                bookmarkClearButton.disabled = !hasBookmark;
            }
        }

        function showBookmarkStatus(message) {
            if (!bookmarkStatus) {
                return;
            }
            if (bookmarkStatusTimer) {
                clearTimeout(bookmarkStatusTimer);
                bookmarkStatusTimer = null;
            }
            if (message) {
                bookmarkStatus.textContent = message;
                bookmarkStatus.classList.add('visible');
                bookmarkStatusTimer = setTimeout(() => {
                    bookmarkStatus.textContent = '';
                    bookmarkStatus.classList.remove('visible');
                }, 4000);
            } else {
                bookmarkStatus.textContent = '';
                bookmarkStatus.classList.remove('visible');
            }
        }

        function saveBookmark(url, pageNumber, options = {}) {
            const { silent = false } = options;
            const key = resolveBookmarkKey(url);
            if (!key || !Number.isInteger(pageNumber) || pageNumber <= 0) {
                return false;
            }
            const normalizedPage = Math.floor(pageNumber);
            bookmarks[key] = {
                pageNumber: normalizedPage,
                updatedAt: Date.now()
            };
            persistBookmarks();
            rememberLastDocument(key, normalizedPage);
            updateBookmarkUI();
            lastAutoSaved = { url: key, pageNumber: normalizedPage };
            if (!silent) {
                showBookmarkStatus(`Bookmark saved at page ${normalizedPage}`);
            }
            return true;
        }

        function clearBookmark(url) {
            const key = resolveBookmarkKey(url);
            if (!key || !Object.prototype.hasOwnProperty.call(bookmarks, key)) {
                return false;
            }
            delete bookmarks[key];
            persistBookmarks();
            rememberLastDocument(key, null);
            updateBookmarkUI();
            if (lastAutoSaved.url === key) {
                lastAutoSaved = { url: key, pageNumber: null };
            }
            if (currentDocumentKey === key) {
                cancelPendingAutoSave();
            }
            return true;
        }

        function requestCurrentPage() {
            if (!viewerReady || !viewer.contentWindow || !currentViewerSource) {
                showBookmarkStatus('Open the PDF before bookmarking.');
                return;
            }
            viewer.contentWindow.postMessage(
                { type: 'requestCurrentPage', payload: { url: currentViewerSource } },
                messageTargetOrigin
            );
        }

        function handleBookmarkMessage(payload) {
            if (!payload) {
                return;
            }
            const rawPage = Math.floor(Number(payload.pageNumber));
            if (!Number.isInteger(rawPage) || rawPage <= 0) {
                return;
            }
            const sourceUrl = payload.url || currentViewerSource;
            if (sourceUrl && currentViewerSource && sourceUrl !== currentViewerSource) {
                return;
            }
            if (!currentDocumentUrl) {
                return;
            }
            saveBookmark(currentDocumentUrl, rawPage);
        }

        function handleAutoSaveMessage(payload) {
            if (!payload) {
                return;
            }
            const rawPage = Math.floor(Number(payload.pageNumber));
            const sourceUrl = payload.url || currentDocumentUrl;
            if (!Number.isInteger(rawPage) || rawPage <= 0) {
                return;
            }
            if (!currentDocumentKey) {
                return;
            }
            scheduleAutoSave(sourceUrl, rawPage);
        }

        function initializeFileMetadata() {
            document.querySelectorAll('.file').forEach((element) => {
                const onclickValue = element.getAttribute('onclick') || '';
                const match = onclickValue.match(/loadPDF\('(.*?)'/);
                if (!match) {
                    return;
                }
                const originalPath = match[1];
                const normalized = normalizePDFPath(originalPath);
                if (!normalized) {
                    return;
                }
                const viewerPath = normalized.startsWith('http') ? normalized : normalized.replace(/^\/+/, '');
                element.dataset.pdfUrl = normalized;
                element.dataset.viewerPath = viewerPath;
            });
        }

        function findFileElementByUrl(url) {
            if (!url) {
                return null;
            }
            const normalized = normalizePDFPath(url);
            if (!normalized) {
                return null;
            }
            return Array.from(document.querySelectorAll('.file')).find(el => el.dataset.pdfUrl === normalized) || null;
        }

        function updateCategoryIcon(header, isOpen) {
            if (!header) {
                return;
            }
            const icon = header.querySelector('.category-icon');
            if (icon) {
                icon.textContent = isOpen ? 'üìÇ' : 'üìÅ';
            }
        }

        function expandParents(element) {
            let parent = element ? element.parentElement : null;
            while (parent) {
                if (parent.classList.contains('file-list')) {
                    parent.classList.add('open');
                    const header = parent.previousElementSibling;
                    if (header && header.classList.contains('subcategory-header')) {
                        header.classList.add('open');
                    }
                }
                if (parent.classList.contains('category-content')) {
                    parent.classList.add('open');
                    const categoryHeader = parent.previousElementSibling;
                    if (categoryHeader && categoryHeader.classList.contains('category-header')) {
                        updateCategoryIcon(categoryHeader, true);
                    }
                }
                parent = parent.parentElement;
            }
        }

        function selectFileElement(element) {
            document.querySelectorAll('.file').forEach(f => f.classList.remove('selected'));
            if (element) {
                element.classList.add('selected');
                expandParents(element);
            }
        }

        window.addEventListener('message', (event) => {
            if (!isFileProtocol && event.origin !== window.location.origin) {
                return;
            }
            const { type, payload } = event.data || {};
            if (!type) {
                return;
            }
            if (type === 'viewerReady') {
                viewerReady = true;
                if (pendingFile) {
                    postOpenRequest(pendingFile);
                    pendingFile = null;
                }
                return;
            }
            if (type === 'currentPage') {
                handleBookmarkMessage(payload);
                return;
            }
            if (type === 'pageChanged') {
                handleAutoSaveMessage(payload);
            }
        });

        function openDocument(path, triggerElement, options = {}) {
            const normalizedPath = normalizePDFPath(path);
            if (!normalizedPath) {
                return;
            }
            const viewerPath = normalizedPath.startsWith('http') ? normalizedPath : normalizedPath.replace(/^\/+/, '');

            flushPendingAutoSave();

            currentDocumentUrl = normalizedPath;
            currentDocumentKey = resolveBookmarkKey(normalizedPath) || normalizedPath;
            currentViewerSource = viewerPath;

            selectFileElement(triggerElement || findFileElementByUrl(currentDocumentUrl));

            placeholder.style.display = 'none';
            viewer.style.display = 'block';

            if (mobileQuery.matches) {
                setSidebarOpen(false);
            }

            const requestedPage = options && options.pageNumber != null ? Math.floor(Number(options.pageNumber)) : null;
            const bookmarkEntry = getBookmark(currentDocumentUrl);
            const savedPage = getBookmarkPage(bookmarkEntry);
            const targetPage = Number.isInteger(requestedPage) && requestedPage > 0 ? requestedPage : savedPage;

            lastAutoSaved = { url: currentDocumentKey, pageNumber: targetPage || null };
            rememberLastDocument(currentDocumentUrl, targetPage);
            updateBookmarkUI();
            showBookmarkStatus('');

            sendOpenRequest(targetPage != null ? { pageNumber: targetPage } : {});
        }

        if (bookmarkSaveButton) {
            bookmarkSaveButton.addEventListener('click', () => {
                if (!currentDocumentUrl) {
                    return;
                }
                requestCurrentPage();
            });
        }

        if (bookmarkResumeButton) {
            bookmarkResumeButton.addEventListener('click', () => {
                if (!currentDocumentUrl) {
                    return;
                }
                const entry = getBookmark(currentDocumentUrl);
                const savedPage = getBookmarkPage(entry);
                if (!Number.isInteger(savedPage) || savedPage <= 0) {
                    showBookmarkStatus('No bookmark saved for this PDF.');
                    return;
                }
                rememberLastDocument(currentDocumentUrl, savedPage);
                lastAutoSaved = { url: currentDocumentKey, pageNumber: savedPage };
                sendOpenRequest({ pageNumber: savedPage });
                showBookmarkStatus(`Opening bookmark at page ${savedPage}`);
            });
        }

        if (bookmarkClearButton) {
            bookmarkClearButton.addEventListener('click', () => {
                if (!currentDocumentUrl) {
                    return;
                }
                const entry = getBookmark(currentDocumentUrl);
                if (!getBookmarkPage(entry)) {
                    showBookmarkStatus('No bookmark to clear.');
                    return;
                }
                if (clearBookmark(currentDocumentUrl)) {
                    showBookmarkStatus('Bookmark cleared.');
                }
            });
        }

        function restoreLastDocument() {
            if (!lastDocument || !lastDocument.url) {
                return false;
            }
            const normalizedUrl = normalizePDFPath(lastDocument.url);
            if (!normalizedUrl) {
                return false;
            }
            const entry = getBookmark(normalizedUrl);
            const savedPage = lastDocument.pageNumber != null ? lastDocument.pageNumber : getBookmarkPage(entry);
            const fileElement = findFileElementByUrl(normalizedUrl);
            openDocument(normalizedUrl, fileElement || null, savedPage != null ? { pageNumber: savedPage } : {});
            return true;
        }

        function sendInitialBookmarkState() {
            updateBookmarkUI();
        }

        sendInitialBookmarkState();

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                flushPendingAutoSave();
            }
        });

        window.addEventListener('beforeunload', () => {
            flushPendingAutoSave();
        });

        window.addEventListener('load', () => {
            setSidebarOpen(false);
            const restored = restoreLastDocument();
            if (!restored) {
                const firstCategory = document.querySelector('.category-header');
                if (firstCategory) {
                    firstCategory.click();
                }
            }
        });

        window.toggleCategory = toggleCategory;
        window.toggleSubcategory = toggleSubcategory;
        window.loadPDF = openDocument;
    </script>
</body>
</html>
